<!DOCTYPE html>
<html>
<head>
    <title>Everon Map Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Inter">
    <style>
        body {
            font-family: 'Inter', serif;
          }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

    <link rel="stylesheet" href="leafletPlugins/leafletMarkerCluster/MarkerCluster.css" />
    <link rel="stylesheet" href="leafletPlugins/leafletMarkerCluster/MarkerCluster.Default.css" />
    <script src="leafletPlugins/leafletMarkerCluster/leaflet.markercluster.js"></script>


    <script src="everon-locations.js"></script>
    <script src="everon-supply-locations.js"></script>

    <style type="text/css">
        #map { height: 1000px; width: 1200px; }

        .common-tooltip {
            background-color: transparent;
            border: transparent;
            box-shadow: none;
        }

        .town-name-tooltip {
            background-color: transparent;
            border: transparent;
            box-shadow: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }

        .resource-depot-tooltip {
            background-color: transparent;
            border: transparent;
            box-shadow: none;
            color: rgb(17, 227, 255);
            font-size: 16px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }

        .hidden-tooltip {
            visibility: hidden;
        }
    </style>

    <script lang="text/javascript">
        function addGridDebug(map) {
            L.GridLayer.GridDebug = L.GridLayer.extend({
                createTile: function (coords) {
                  const tile = document.createElement('div');
                  tile.style.outline = '1px solid #111';
                  tile.style.fontWeight = 'bold';
                  tile.style.fontSize = '14pt';
                  tile.style.color = 'red';
                  tile.innerHTML = [coords.z, coords.x, -(coords.y+1)].join('/');
                  return tile;
                },
              });
              
            L.gridLayer.gridDebug = function (opts) {
                return new L.GridLayer.GridDebug(opts);
            };
            
            // Add debug grid overlay
            map.addLayer(L.gridLayer.gridDebug());
        }
    </script>
</head>
<body>
    <h1>Everon Supplies [TEST]</h1>
    <p>The location of every supply cache which can be used in the Conflict game mode.</p>
    <p>This page is a test, and will not be permanently available.</p>
    <!-- <p>Clicked game coordinates => X:<span id="xCoord"></span>, Z: <span id="zCoord"></span></p> -->
    <div id="map"></div>
    <p>Made by Bewilderbeest</p>

    <script>
        function gameCoordsToLatLng(coordPair) {
          return L.latLng([coordPair[1] + 50, coordPair[0] + 50]);
        }

        function latLngToGameCoords(latlng) {
          return [latlng.lng - 50, latlng.lat - 50];
        }

        // Define a custom CRS to match the game's coordinate system
        // This is identical to L.CRS.Simple, but with a custom scale factor
        L.CRS.CustomSimple = L.Util.extend({}, L.CRS, {
          projection: L.Projection.LonLat,
          transformation: new L.Transformation(1/12.501, 0, -1/12.501, 0), // I had to eyeball this scale factor!

          scale(zoom) {
              return Math.pow(2, zoom);
          },

          zoom(scale) {
              return Math.log(scale) / Math.LN2;
          },

          distance(latlng1, latlng2) {
              const dx = latlng2.lng - latlng1.lng,
                  dy = latlng2.lat - latlng1.lat;

              return Math.sqrt(dx * dx + dy * dy);
          },

              infinite: true
        });

        var map = L.map('map', {
            crs: L.CRS.CustomSimple,
            center: [6400, 6400],
            zoom: 0,
        });

        // Invert the y axis so we can use the same tile naming scheme as the game
        L.TileLayer.InvertedY = L.TileLayer.extend({
            getTileUrl: function(tilecoords) {
                tilecoords.y = -(tilecoords.y + 1);
                return L.TileLayer.prototype.getTileUrl.call(this, tilecoords);
            }
        });

        var bounds = [[0,0], [12800,12800]];

        // create a tile layer, and invert the z axis as we name by LODs
        tileLayer = new L.TileLayer.InvertedY('LODS/{z}/{x}/{y}/tile.jpg', {
            maxZoom: 5,
            minZoom: 0,
            bounds: bounds, // i.e. [[0,0], [12800,12800]],
            maxNativeZoom: 5,
        }).addTo(map);



        // All points from Conflict
        // Saint-Pierre
        // Vernon
        // Pennants Pass
        // Durras
        // Black Lake
        // Regina
        // Tower Regina
        // Quarry
        // Camurac
        // Mil Base Levie
        // Levie
        // Laruns
        // Simon's Wood
        // Chotain
        // Coastal Base Morton
        // Morton Valley
        // Coastal Base Chotain
        // Figari
        // Provins
        // Pinewood Lake
        // Cavalry Hill
        // Old Wood
        // Le Moule
        // Coastal Base Lamentin
        // Villeneuve
        // Tiller's Find
        // Montignac
        // Entre-Deux
        // Andre's Beacon
        // Hornbeam Valley
        // Gravette
        // Military Hospital
        // Tyrone
        // Meaux
        // Kermovan
        // Military Depot
        // Saint-Phillipe
        // Airbase Saint-Phillipe

        // Add some markers to verify coordinates are working correctly
        // var northBuoy = gameCoordsToLatLng([967.172, 12196.345]);
        // L.marker(northBuoy).addTo(map);
        // var oldFort = gameCoordsToLatLng([3415.019, 1455.202]);
        // L.marker(oldFort).addTo(map);
        // var beachUmbrella = gameCoordsToLatLng([11498.44, 10896.933]);
        // L.marker(beachUmbrella).addTo(map);

        // DEFAULT VIEWS
        //map.setView( beachUmbrella, 1);
        //map.setView( L.latLng([500, 500]), 5);
        
        // Tooltips
        var stPhillipeTooltip = L.tooltip(locSaintPhillipe, {content: 'St Phillipe', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var montignacTooltip = L.tooltip(locMontignac, {content: 'Montignac', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var saintPierreTooltip = L.tooltip(locSaintPierre, {content: 'St Pierre', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var mortonTooltip = L.tooltip(locMorton, {content: 'Morton', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var figariTooltip = L.tooltip(locFigari, {content: 'Figari', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var lamentinTooltip = L.tooltip(locLamentin, {content: 'Lamentin', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var chotainTooltip = L.tooltip(locChotain, {content: 'Chotain', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var levieTooltip = L.tooltip(locLevie, {content: 'Levie', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var durrasTooltip = L.tooltip(locDurras, {content: 'Durras', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var meauxTooltip = L.tooltip(locMeaux, {content: 'Meaux', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var camuracTooltip = L.tooltip(locCamurac, {content: 'Camurac', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var provinsTooltip = L.tooltip(locProvins, {content: 'Provins', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var andresBeaconTooltip = L.tooltip(locAndresBeacon, {content: 'Andres Beacon', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var gravetteTooltip = L.tooltip(locGravette, {content: 'Gravette', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var quarryTooltip = L.tooltip(locQuarry, {content: 'Quarry', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var reginaTooltip = L.tooltip(locRegina, {content: 'Regina', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var villeneuveTooltip = L.tooltip(locVilleneuve, {content: 'Villeneuve', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var airportTooltip = L.tooltip(locAirport, {content: 'Airport', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var powerplantTooltip = L.tooltip(locPowerplant, {content: 'Power Plant', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);
        var tyroneTooltip = L.tooltip(locTyrone, {content: 'Tyrone', permanent: true, direction: "center", className: "common-tooltip town-name-tooltip" }).addTo(map);

        // label all resource depots
        var resourceDepotFarmTooltip = L.tooltip(resourceDepotFarm, {content: 'Farm', permanent: true, direction: "center", className: "common-tooltip resource-depot-tooltip" }).addTo(map);
        //var resourceDepotMeauxHarborTooltip = L.tooltip(resourceDepotMeauxHarbor, {content: 'Resources: Meaux Harbor', permanent: true, direction: "center", className: "common-tooltip resource-depot-tooltip" }).addTo(map);
        var resourceDepotGoreyTooltip = L.tooltip(resourceDepotGorey, {content: 'Gorey', permanent: true, direction: "center", className: "common-tooltip resource-depot-tooltip" }).addTo(map);
        //var resourceDepotPinewoodLakeTooltip = L.tooltip(resourceDepotPinewoodLake, {content: 'Resources: Pinewood Lake', permanent: true, direction: "center", className: "common-tooltip resource-depot-tooltip" }).addTo(map);
        //var resourceDepotLevieTooltip = L.tooltip(resourceDepotLevie, {content: 'Resources: Levie', permanent: true, direction: "center", className: "common-tooltip resource-depot-tooltip" }).addTo(map);
        //var resourceDepotDurrasHillTooltip = L.tooltip(resourceDepotDurrasHill, {content: 'Resources: Durras Hill', permanent: true, direction: "center", className: "common-tooltip resource-depot-tooltip" }).addTo(map);
        var resourceDepotSawmillTooltip = L.tooltip(resourceDepotSawmill, {content: 'Sawmill', permanent: true, direction: "center", className: "common-tooltip resource-depot-tooltip" }).addTo(map);
        //var resourceDepotReginaTooltip = L.tooltip(resourceDepotRegina, {content: 'Resources: Regina', permanent: true, direction: "center", className: "common-tooltip resource-depot-tooltip" }).addTo(map);
        //var resourceDepotChotainIndustrialTooltip = L.tooltip(resourceDepotChotainIndustrial, {content: 'Resources: Chotain Industrial', permanent: true, direction: "center", className: "common-tooltip resource-depot-tooltip" }).addTo(map);


        //addGridDebug(map); // Uncomment to add a grid overlay for debugging

        // Simple test code to verify placing markers and getting coordinates
        var lat, lng, marker;
        map.on("click", function (e) {
           if (marker) map.removeLayer(marker);
           lat = e.latlng.lat;
           lng = e.latlng.lng;
           var gameCoords = latLngToGameCoords(e.latlng);
           console.log(gameCoords);
           marker = L.marker([lat, lng]).addTo(map);
          //  document.getElementById("xCoord").textContent = gameCoords[0];
          //  document.getElementById("zCoord").textContent = gameCoords[1];
        });


        var clusteredMarkers = L.markerClusterGroup({
            disableClusteringAtZoom : 5
        });

        // Load 'everon-locations.js'
        supplyLocations.forEach(coord => {
            console.log(coord);
            var coordLatLng = gameCoordsToLatLng([coord[0], coord[1]]);
            //var coordMarker = L.marker(coordLatLng).addTo(map); // add directly to map
            var coordMarker = L.marker(coordLatLng, { title: 'Test' });
            clusteredMarkers.addLayer(coordMarker);
        });
        
        map.addLayer(clusteredMarkers);

        //Hide tooltips based on zoom level. Currently This is set to 17
        map.on('zoomend', function(e){
            var zoomLevel = map.getZoom();
            if (zoomLevel == 5 ){
                [].forEach.call(document.querySelectorAll('.common-tooltip'), function (el) {
                    // add hidden-tooltip class to hide
                    console.log(`Hiding ${el}`);
                    el.classList.add('hidden-tooltip');
                });
            }else{
                [].forEach.call(document.querySelectorAll('.common-tooltip'), function (el) {
                    console.log(`Showing ${el}`);
                    el.classList.remove('hidden-tooltip');
                });
            }
        });

    </script>
</body>
</html>