<!DOCTYPE html>
<html>
<head>
    <title>Everon Map Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <style type="text/css">
        #map { height: 800px; width: 1000px; }

        .town-name-tooltip {
            background-color: transparent;
            border: transparent;
            box-shadow: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 1px 1px 1px black;
        }
    </style>

    <script lang="text/javascript">
        function addGridDebug(map) {
            L.GridLayer.GridDebug = L.GridLayer.extend({
                createTile: function (coords) {
                  const tile = document.createElement('div');
                  tile.style.outline = '1px solid #111';
                  tile.style.fontWeight = 'bold';
                  tile.style.fontSize = '14pt';
                  tile.style.color = 'red';
                  tile.innerHTML = [coords.z, coords.x, -(coords.y+1)].join('/');
                  return tile;
                },
              });
              
            L.gridLayer.gridDebug = function (opts) {
                return new L.GridLayer.GridDebug(opts);
            };
            
            // Add debug grid overlay
            map.addLayer(L.gridLayer.gridDebug());
        }
    </script>
</head>
<body>
    <h1>Everon Map Test</h1>
    <p>Clicked game coordinates => X:<span id="xCoord"></span>, Z: <span id="zCoord"></span></p>
    <div id="map"></div>
    <script>
        // Define a custom CRS to match the game's coordinate system
        // This is identical to L.CRS.Simple, but with a custom scale factor
        L.CRS.CustomSimple = L.Util.extend({}, L.CRS, {
            projection: L.Projection.LonLat,
            transformation: new L.Transformation(1/12.501, 0, -1/12.501, 0), // I had to eyeball this scale factor!
        
            scale(zoom) {
                return Math.pow(2, zoom);
            },
        
            zoom(scale) {
                return Math.log(scale) / Math.LN2;
            },
        
            distance(latlng1, latlng2) {
                const dx = latlng2.lng - latlng1.lng,
                    dy = latlng2.lat - latlng1.lat;
        
                return Math.sqrt(dx * dx + dy * dy);
            },
        
            infinite: true
        });

        var map = L.map('map', {
            crs: L.CRS.CustomSimple,
            center: [4775.641, 7086.945],
            zoom: 0,
        });

        // Define the bounds of the map in game coordinates
        var bounds = [[0,0], [12800,12800]];

        // Invert the y axis so we can use the same tile naming scheme as the game
        L.TileLayer.InvertedY = L.TileLayer.extend({
            getTileUrl: function(tilecoords) {
                tilecoords.y = -(tilecoords.y + 1);
                return L.TileLayer.prototype.getTileUrl.call(this, tilecoords);
            }
        });

        // create a tile layer, and invert the z axis as we name by LODs
        tileLayer = new L.TileLayer.InvertedY('LODS/{z}/{x}/{y}/tile.jpg', {
            maxZoom: 5,
            minZoom: 0,
            zoomReverse: true,
            bounds: bounds,
        }).addTo(map);

        // This +50 accounts for our offset as the camera looks down into the center of LOD0 tiles, not the corner
        function gameCoordsToLatLng(coordPair) {
            return L.latLng([coordPair[1] + 50, coordPair[0] + 50]);
        }

        function latLngToGameCoords(latlng) {
            return [latlng.lng - 50, latlng.lat - 50];
        }

        // Some hardcoded locations for Eden/Everon
        var saintPhillipe = gameCoordsToLatLng([4500.872, 10776.053]);
        var montignac = gameCoordsToLatLng([4775.641, 7086.945]);
        var meaux = gameCoordsToLatLng([4517.52, 9467.668]);
        var saintPierre = gameCoordsToLatLng([9689.432, 1558.166]);
        var morton = gameCoordsToLatLng([5137.254, 4009.941]);
        var figari = gameCoordsToLatLng([5256.366, 5341.263]);
        var lamentin = gameCoordsToLatLng([1281.055, 5946.839]);
        var chotain = gameCoordsToLatLng([7087.74, 6011.904]);
        var levie = gameCoordsToLatLng([7456.592, 4737.094]);
        var durras = gameCoordsToLatLng([8826.12, 2746.123]);

        // Add some markers to verify coordinates are working correctly
        var northBuoy = gameCoordsToLatLng([967.172, 12196.345]);
        L.marker(northBuoy).addTo(map);

        var oldFort = gameCoordsToLatLng([3415.019, 1455.202]);
        L.marker(oldFort).addTo(map);

        var beachUmbrella = gameCoordsToLatLng([11498.44, 10896.933]);
        L.marker(beachUmbrella).addTo(map);

        // DEFAULT VIEWS
        //map.setView( beachUmbrella, 1);
        //map.setView( L.latLng([500, 500]), 5);
        
        // Tooltips
        var stPhillipeTooltip = L.tooltip(saintPhillipe, {content: 'St Phillipe', permanent: true, direction: "center", className: "town-name-tooltip" }).addTo(map);
        var montignacTooltip = L.tooltip(montignac, {content: 'Montignac', permanent: true, direction: "center", className: "town-name-tooltip" }).addTo(map);
        var saintPierreTooltip = L.tooltip(saintPierre, {content: 'St Pierre', permanent: true, direction: "center", className: "town-name-tooltip" }).addTo(map);
        var mortonTooltip = L.tooltip(morton, {content: 'Morton', permanent: true, direction: "center", className: "town-name-tooltip" }).addTo(map);
        var figariTooltip = L.tooltip(figari, {content: 'Figari', permanent: true, direction: "center", className: "town-name-tooltip" }).addTo(map);
        var lamentinTooltip = L.tooltip(lamentin, {content: 'Lamentin', permanent: true, direction: "center", className: "town-name-tooltip" }).addTo(map);
        var chotainTooltip = L.tooltip(chotain, {content: 'Chotain', permanent: true, direction: "center", className: "town-name-tooltip" }).addTo(map);
        var levieTooltip = L.tooltip(levie, {content: 'Levie', permanent: true, direction: "center", className: "town-name-tooltip" }).addTo(map);
        var durrasTooltip = L.tooltip(durras, {content: 'Durras', permanent: true, direction: "center", className: "town-name-tooltip" }).addTo(map);
        var meauxTooltip = L.tooltip(meaux, {content: 'Meaux', permanent: true, direction: "center", className: "town-name-tooltip" }).addTo(map);
        
        //addGridDebug(map); // Uncomment to add a grid overlay for debugging

        // Simple test code to verify placing markers and getting coordinates
        var lat, lng, marker;
        map.on("click", function (e) {
            if (marker) map.removeLayer(marker);
            lat = e.latlng.lat;
            lng = e.latlng.lng;

            var gameCoords = latLngToGameCoords(e.latlng);
            marker = L.marker([lat, lng]).addTo(map);
            document.getElementById("xCoord").textContent = gameCoords[0];
            document.getElementById("zCoord").textContent = gameCoords[1];
        });

    </script>
</body>
</html>